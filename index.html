<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel CRUD Supabase</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table, th, td { border: 1px solid #aaa; }
    th, td { padding: 8px; text-align: left; }
    td[contenteditable="true"] { background: #f9f9f9; }
    form { margin-bottom: 20px; }
    input, select, button { margin: 5px; padding: 5px; }
    
    /* Estilos para el log */
    .log-container {
      margin-top: 30px;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      background-color: #f5f5f5;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .log-entry {
      padding: 5px;
      margin: 2px 0;
      border-radius: 3px;
      font-family: monospace;
      font-size: 14px;
    }
    .log-success { background-color: #d4edda; color: #155724; }
    .log-error { background-color: #f8d7da; color: #721c24; }
    .log-info { background-color: #d1ecf1; color: #0c5460; }
    .log-warning { background-color: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <h1>Gestión con Supabase</h1>

  <!-- Formulario Categorías -->
  <h2>Agregar Categoría</h2>
  <form id="formCategoria">
    <input type="text" id="catNombre" placeholder="Nombre categoría" required>
    <button type="submit">Agregar</button>
  </form>

  <table id="tablaCategorias">
    <thead>
      <tr><th>ID</th><th>Nombre</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Formulario Items -->
  <h2>Agregar Item</h2>
  <form id="formItem">
    <input type="text" id="itemNombre" placeholder="Nombre" required>
    <input type="text" id="itemDescripcion" placeholder="Descripción">
    <select id="itemCategoria"></select>
    <button type="submit">Agregar</button>
  </form>

  <table id="tablaItems">
    <thead>
      <tr><th>ID</th><th>Nombre</th><th>Descripción</th><th>Categoría</th><th>Acciones</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <!-- Esquema / Diagrama BD -->
  <h2>Esquema / Diagrama de la Base de Datos</h2>
  <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap: wrap;">
    <div style="flex:2; min-width: 300px;">
      <div style="display:flex; justify-content: space-between; align-items:center;">
        <strong>Diagrama ER (Mermaid)</strong>
        <button id="refreshSchema">Actualizar diagrama</button>
      </div>
      <div id="dbDiagram" style="border:1px solid #ccc; padding:10px; margin-top:8px; overflow:auto;"></div>
    </div>
    <div style="flex:1; min-width: 260px;">
      <strong>Resumen</strong>
      <div id="dbSummary" style="border:1px solid #ccc; padding:10px; margin-top:8px; background:#fafafa;"></div>
    </div>
  </div>
  <!-- Sección de Log -->
  <div class="log-container">
    <div class="log-header">
      <h2>Log de Actividades</h2>
      <button id="descargarLog">Descargar Log</button>
    </div>
    <div id="logContent"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const supabase = createClient(
      "https://crsjimftjwevpfcqjmhu.supabase.co", // tu proyecto
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyc2ppbWZ0andldnBmY3FqbWh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNDY0MjAsImV4cCI6MjA3MzcyMjQyMH0.y-j95MWGnSrKYvIua7lxMsYYVywclJjSeSJvvBLl9hw"
    );

    const tablaCategorias = document.querySelector("#tablaCategorias tbody");
    const tablaItems = document.querySelector("#tablaItems tbody");
    const formCategoria = document.getElementById("formCategoria");
    const formItem = document.getElementById("formItem");
    const selCategoria = document.getElementById("itemCategoria");
    const logContent = document.getElementById("logContent");
    const descargarLogBtn = document.getElementById("descargarLog");
    const dbDiagram = document.getElementById("dbDiagram");
const dbSummary = document.getElementById("dbSummary");
const refreshSchemaBtn = document.getElementById("refreshSchema");

    // ---------- SISTEMA DE LOG ----------
    function agregarLog(mensaje, tipo = "info") {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = document.createElement("div");
      logEntry.className = `log-entry log-${tipo}`;
      logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${mensaje}`;
      logContent.appendChild(logEntry);
      logContent.scrollTop = logContent.scrollHeight; // Auto-scroll al final
    }

    // Función para descargar el log
    descargarLogBtn.addEventListener("click", () => {
      const logEntries = logContent.querySelectorAll(".log-entry");
      let logText = "Log de Actividades - Panel CRUD Supabase\n";
      logText += "============================================\n\n";
      
      logEntries.forEach(entry => {
        const texto = entry.textContent || entry.innerText;
        logText += texto + "\n";
      });
      
      const blob = new Blob([logText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `log_${new Date().toISOString().slice(0, 10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      agregarLog("Log descargado exitosamente", "success");
    });

    // ---------- CATEGORÍAS ----------
    async function cargarCategorias() {
      agregarLog("Cargando categorías...", "info");
      
      const { data, error } = await supabase.from("categorias").select("*").order("id", { ascending: true });
      if (error) {
        agregarLog(`Error al cargar categorías: ${error.message}`, "error");
        return console.error(error);
      }

      agregarLog(`Se cargaron ${data.length} categorías`, "success");

      // llenar tabla
      tablaCategorias.innerHTML = "";
      selCategoria.innerHTML = "";
      data.forEach(cat => {
        // tabla
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${cat.id}</td>
          <td contenteditable="true" data-id="${cat.id}" data-campo="nombre">${cat.nombre}</td>
          <td><button onclick="eliminarCategoria(${cat.id})">Borrar</button></td>
        `;
        tablaCategorias.appendChild(fila);

        // combo
        const opt = document.createElement("option");
        opt.value = cat.id;
        opt.textContent = cat.nombre;
        selCategoria.appendChild(opt);
      });
    }

    formCategoria.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nombre = document.getElementById("catNombre").value;
      
      agregarLog(`Intentando agregar categoría: "${nombre}"`, "info");
      
      const { error } = await supabase.from("categorias").insert([{ nombre }]);
      
      if (error) {
        agregarLog(`Error al agregar categoría: ${error.message}`, "error");
      } else {
        agregarLog(`Categoría "${nombre}" agregada exitosamente`, "success");
      }
      
      formCategoria.reset();
      cargarCategorias();
    });

    tablaCategorias.addEventListener("blur", async (e) => {
      if (e.target.hasAttribute("contenteditable")) {
        const id = e.target.dataset.id;
        const campo = e.target.dataset.campo;
        const valor = e.target.innerText;
        
        agregarLog(`Actualizando categoría ID ${id}, campo "${campo}" a: "${valor}"`, "info");
        
        const { error } = await supabase.from("categorias").update({ [campo]: valor }).eq("id", id);
        
        if (error) {
          agregarLog(`Error al actualizar categoría: ${error.message}`, "error");
        } else {
          agregarLog(`Categoría ID ${id} actualizada exitosamente`, "success");
        }
      }
    }, true);

    window.eliminarCategoria = async (id) => {
      if (!confirm("¿Está seguro de que desea eliminar esta categoría?")) return;
      
      agregarLog(`Intentando eliminar categoría ID ${id}`, "warning");
      
      const { error } = await supabase.from("categorias").delete().eq("id", id);
      
      if (error) {
        agregarLog(`Error al eliminar categoría: ${error.message}`, "error");
      } else {
        agregarLog(`Categoría ID ${id} eliminada exitosamente`, "success");
      }
      
      cargarCategorias();
      cargarItems();
    };

    // ---------- ITEMS ----------
    async function cargarItems() {
      agregarLog("Cargando items...", "info");
      
      const { data, error } = await supabase
        .from("items")
        .select("id, nombre, descripcion, categoria_id, categorias(nombre)")
        .order("id", { ascending: false });

      if (error) {
        agregarLog(`Error al cargar items: ${error.message}`, "error");
        return console.error(error);
      }

      agregarLog(`Se cargaron ${data.length} items`, "success");

      tablaItems.innerHTML = "";
      data.forEach(it => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${it.id}</td>
          <td contenteditable="true" data-id="${it.id}" data-campo="nombre">${it.nombre}</td>
          <td contenteditable="true" data-id="${it.id}" data-campo="descripcion">${it.descripcion ?? ""}</td>
          <td>${it.categorias?.nombre ?? "-"}</td>
          <td><button onclick="eliminarItem(${it.id})">Borrar</button></td>
        `;
        tablaItems.appendChild(fila);
      });
    }

    formItem.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nombre = document.getElementById("itemNombre").value;
      const descripcion = document.getElementById("itemDescripcion").value;
      const categoria_id = selCategoria.value;
      const categoria_nombre = selCategoria.options[selCategoria.selectedIndex].text;
      
      agregarLog(`Intentando agregar item: "${nombre}" (Categoría: ${categoria_nombre})`, "info");
      
      const { error } = await supabase.from("items").insert([{ nombre, descripcion, categoria_id }]);
      
      if (error) {
        agregarLog(`Error al agregar item: ${error.message}`, "error");
      } else {
        agregarLog(`Item "${nombre}" agregado exitosamente`, "success");
      }
      
      formItem.reset();
      cargarItems();
    });

    tablaItems.addEventListener("blur", async (e) => {
      if (e.target.hasAttribute("contenteditable")) {
        const id = e.target.dataset.id;
        const campo = e.target.dataset.campo;
        const valor = e.target.innerText;
        
        agregarLog(`Actualizando item ID ${id}, campo "${campo}" a: "${valor}"`, "info");
        
        const { error } = await supabase.from("items").update({ [campo]: valor }).eq("id", id);
        
        if (error) {
          agregarLog(`Error al actualizar item: ${error.message}`, "error");
        } else {
          agregarLog(`Item ID ${id} actualizado exitosamente`, "success");
        }
      }
    }, true);

    window.eliminarItem = async (id) => {
      if (!confirm("¿Está seguro de que desea eliminar este item?")) return;
      
      agregarLog(`Intentando eliminar item ID ${id}`, "warning");
      
      const { error } = await supabase.from("items").delete().eq("id", id);
      
      if (error) {
        agregarLog(`Error al eliminar item: ${error.message}`, "error");
      } else {
        agregarLog(`Item ID ${id} eliminado exitosamente`, "success");
      }
      
      cargarItems();
    };

    // Inicial
    agregarLog("Inicializando aplicación...", "info");
    cargarCategorias();
    construirDiagramaYResumen();
    cargarItems();
    agregarLog("Aplicación inicializada correctamente", "success");

    // ---------- DIAGRAMA Y RESUMEN BD ----------
function getFallbackColumns(nombreTabla) {
  const mapa = {
    categorias: ["id", "nombre"],
    items: ["id", "nombre", "descripcion", "categoria_id"],
  };
  return mapa[nombreTabla] || [];
}

async function obtenerInfoTabla(nombreTabla) {
  const { count, error: countError } = await supabase
    .from(nombreTabla)
    .select('*', { count: 'exact', head: true });

  if (countError) {
    agregarLog(`Error al contar filas en ${nombreTabla}: ${countError.message}`, 'error');
  }

  let columnas = [];
  const { data: sample, error: sampleError } = await supabase
    .from(nombreTabla)
    .select('*')
    .limit(1);

  if (!sampleError && sample && sample.length > 0) {
    columnas = Object.keys(sample[0]);
  } else {
    columnas = getFallbackColumns(nombreTabla);
  }

  return { nombre: nombreTabla, filas: count ?? 0, columnas };
}

function construirMermaidER(infoCategorias, infoItems) {
  const columnasCat = infoCategorias.columnas.map(c => `    string ${c}`).join('\n');
  const columnasItm = infoItems.columnas.map(c => `    string ${c}`).join('\n');

  return `erDiagram
  categorias {
${columnasCat}
  }
  items {
${columnasItm}
  }
  categorias ||--o{ items : "1 a N"`;
}

async function construirDiagramaYResumen() {
  try {
    if (window.mermaid && typeof window.mermaid.initialize === 'function') {
      window.mermaid.initialize({ startOnLoad: false, theme: 'default' });
    }

    const [infoCategorias, infoItems] = await Promise.all([
      obtenerInfoTabla('categorias'),
      obtenerInfoTabla('items'),
    ]);

    const mermaidSrc = construirMermaidER(infoCategorias, infoItems);

    if (window.mermaid && typeof window.mermaid.render === 'function') {
      const { svg } = await window.mermaid.render('db-er', mermaidSrc);
      dbDiagram.innerHTML = svg;
    } else {
      dbDiagram.textContent = mermaidSrc;
    }

    dbSummary.innerHTML = '';
    [infoCategorias, infoItems].forEach(info => {
      const cont = document.createElement('div');
      cont.style.marginBottom = '10px';
      cont.innerHTML = `
        <div><strong>Tabla:</strong> ${info.nombre}</div>
        <div><strong>Filas:</strong> ${info.filas}</div>
        <div><strong>Columnas:</strong> ${info.columnas.join(', ') || '-'}</div>
      `;
      dbSummary.appendChild(cont);
    });

    agregarLog('Diagrama y resumen de BD actualizados', 'success');
  } catch (e) {
    agregarLog(`Error al construir diagrama: ${e.message}`, 'error');
    console.error(e);
  }
}

if (refreshSchemaBtn) {
  refreshSchemaBtn.addEventListener('click', () => {
    construirDiagramaYResumen();
  });
}
  </script>
</body>
</html>
